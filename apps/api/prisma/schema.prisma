generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === ENUMS (PostgreSQL native) ===

enum PlanType {
  FREE
  PRO
  BUSINESS
  BETA_TESTER
  WAITLIST  // For landing page waitlist signups
}

enum UserRole {
  USER
  ADMIN
}

enum AuthTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  MAGIC_LINK
}

enum AuthEventType {
  // Magic Link
  MAGIC_LINK_SENT
  MAGIC_LINK_CLICKED
  MAGIC_LINK_EXPIRED

  // Registration & Verification
  USER_REGISTERED
  EMAIL_VERIFIED

  // Login/Logout
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT

  // Password
  PASSWORD_SET
  PASSWORD_CHANGED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED

  // Security
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SESSION_REVOKED
}

// === NOTIFICATIONS ===

enum NotificationType {
  // Auth & Security
  WELCOME
  EMAIL_VERIFIED
  PASSWORD_CHANGED
  NEW_LOGIN
  API_KEY_CREATED
  API_KEY_DELETED

  // Billing
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  TRIAL_ENDING

  // Limits & Usage
  LIMIT_WARNING
  LIMIT_REACHED

  // Automation
  AUTOMATION_SUCCESS
  AUTOMATION_ERROR
  CHANNEL_DISCONNECTED

  // Reports
  DAILY_REPORT
  WEEKLY_REPORT

  // Marketing
  ONBOARDING_REMINDER
  FEATURE_ANNOUNCEMENT
}

enum NotificationChannel {
  EMAIL
  IN_APP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
  DISMISSED
}

enum NotificationCategory {
  SYSTEM // Account, billing, security
  AUTOMATION // Deal published, automation error
  ANALYTICS // Reports, insights
  PRODUCT // New features, updates
}

enum NotificationPriority {
  LOW // Can wait, batched
  MEDIUM // Show soon, non-urgent
  HIGH // Show immediately, important
  CRITICAL // Interrupt user, requires action
}

// === BILLING ===

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  TRIALING
  PAUSED
}

enum ChannelPlatform {
  TELEGRAM
  DISCORD
}

enum ChannelStatus {
  CONNECTED
  PENDING
  ERROR
}

enum TriggerType {
  SCHEDULE
  SCORE_THRESHOLD
  PRICE_DROP
}

enum ActionType {
  PUBLISH_CHANNEL
  SEND_EMAIL
  WEBHOOK
}

enum DealPublishMode {
  DISCOUNTED_ONLY // Solo prodotti con prezzo barrato visibile su Amazon (listPrice > currentPrice)
  LOWEST_PRICE // Solo prodotti al prezzo piÃ¹ basso storico (anche senza sconto visibile)
  BOTH // Entrambi i tipi di deal
}

// === SCHEDULER ENUMS ===

enum LinkType {
  DEAL // Link a prodotto da automazione
  BOUNTY // Link bounty (Prime, Audible, etc.)
  SCHEDULED // Link da scheduled post
  MANUAL // Link creato manualmente
}

enum ScheduledPostType {
  CUSTOM // Testo libero programmato
  BOUNTY // Link bounty Amazon (Prime, Audible, Music, Kindle)
  RECAP // Top deals delle ultime 24h con LLM
  CROSS_PROMO // Promozione altri canali del network
  WELCOME // Benvenuto ai nuovi iscritti
  SPONSORED // Contenuti brand/sponsor
}

enum ExecutionStatus {
  PENDING // In coda
  RUNNING // In esecuzione
  SUCCESS // Completato con successo
  FAILED // Fallito
  SKIPPED_CONFLICT // Saltato per conflitto con deal
  SKIPPED_RATE_LIMIT // Saltato per rate limit
  SKIPPED_CHANNEL // Saltato per canale disattivato
  RETRY // In attesa di retry
  RESCHEDULED // Riprogrammato per conflitto
}

// === USER & AUTHENTICATION ===

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  name     String?
  password String? // Hashed password (bcrypt)
  role     UserRole @default(USER)
  plan     PlanType @default(FREE)
  ttl      Int      @default(72) // hours
  brandId  String?

  // Email verification
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  // Two-Factor Authentication (TOTP)
  totpSecret    String?   // Encrypted TOTP secret
  totpEnabled   Boolean   @default(false)
  totpVerifiedAt DateTime?
  backupCodes   String[]  // Hashed backup codes

  // Beta Testing
  betaInviteCodeId String?
  betaInviteCode   BetaInviteCode? @relation(fields: [betaInviteCodeId], references: [id], onDelete: SetNull)

  // Account status
  isActive            Boolean   @default(true)
  lastLoginAt         DateTime?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Persona Profile (from onboarding survey)
  personaType         String?   // 'beginner' | 'creator' | 'power_user' | 'monetizer'
  experienceLevel     String?   // 'beginner' | 'intermediate' | 'advanced'
  audienceSize        String?   // 'starting' | 'small' | 'medium' | 'large'
  primaryGoal         String?   // 'sales' | 'audience' | 'monetize'
  preferredChannels   String[]  @default([]) // ['telegram', 'email', 'discord']
  hasAmazonAssociates Boolean   @default(false)
  onboardingCompletedAt DateTime?

  // Email Preferences
  emailPrefs_weeklyReport     Boolean @default(true)  // Weekly performance summary
  emailPrefs_dailyDigest      Boolean @default(false) // Daily stats digest
  emailPrefs_automationAlerts Boolean @default(true)  // Automation errors/warnings
  emailPrefs_dealDigest       String  @default("off") // 'realtime' | 'hourly' | 'daily' | 'off'
  emailPrefs_marketing        Boolean @default(true)  // Product updates, tips
  emailPrefs_timezone         String  @default("Europe/Rome")
  lastWeeklyReportAt          DateTime?
  lastDailyDigestAt           DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  apiKeys            ApiKey[]
  credentials        Credential[]
  channels           Channel[]
  affiliateLinks     AffiliateLink[]
  keepaBudgets       KeepaMonthlyBudget[]
  automationRules    AutomationRule[]
  automationSplits   AutomationSplit[]
  messageTemplates   MessageTemplate[]
  onboardingProgress OnboardingProgress?
  achievements       Achievement[]
  authTokens         AuthToken[]
  authEvents         AuthEvent[]
  notifications      Notification[]
  subscription       Subscription?
  automations        Automation[]
  scheduledPosts     ScheduledPost[]
  affiliateTags      AffiliateTag[]
  sessions           Session[]
  telegramUsers      TelegramUser[] // Telegram users linked to this account
  trackingIds        UserTrackingId[] // Amazon Attribution tracking IDs

  // Amazon Associates Import
  amazonReportImports AmazonReportImport[]
  amazonOrders        AmazonOrder[]
  amazonDailyStats    AmazonDailyStats[]
  amazonTrackingStats AmazonTrackingStats[]

  @@index([email])
  @@index([plan])
  @@index([betaInviteCodeId])
}

model AuthToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token String        @unique // Secure random token (hashed)
  type  AuthTokenType

  expiresAt DateTime
  usedAt    DateTime? // When the token was used (null if not used)

  // Metadata for security
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([type])
  @@index([expiresAt])
}

// Auth Events - Audit log for authentication activities
model AuthEvent {
  id String @id @default(uuid())

  // Event type
  type AuthEventType

  // User (optional - some events like failed login may not have user)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  email  String? // Store email for events without user (failed login attempts)

  // Context
  ipAddress String?
  userAgent String?
  metadata  Json? // Additional context (e.g., failure reason, device info)

  // Timestamp
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([type])
  @@index([createdAt])
}

model ApiKey {
  id        String    @id @default(uuid())
  key       String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([userId])
}

// === CREDENTIALS & CHANNELS ===

model Credential {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider  String // e.g., "OPENAI", "ANTHROPIC", "TELEGRAM_BOT"
  key       String // Encrypted value
  label     String? // User friendly name
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  channels  Channel[]
  telegramUsers TelegramUser[] // Telegram users tracked by this bot credential

  @@index([userId])
  @@index([provider])
}

model Channel {
  id              String               @id @default(uuid())
  userId          String
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  platform        ChannelPlatform
  channelId       String // e.g., "@mychannel" or "-100..."
  credentialId    String?
  credential      Credential?          @relation(fields: [credentialId], references: [id], onDelete: SetNull)
  status          ChannelStatus        @default(PENDING)
  amazonTag       String? // Tag Amazon specifico per questo canale (override user default)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AUDIENCE TYPE (per algoritmo scoring dinamico)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Tipo di audience: 'product_hunters' | 'deal_explorers' | 'niche_focused' | 'unknown'
  audienceType           String?
  /// Come Ã¨ stato determinato: 'onboarding' | 'inferred'
  audienceTypeSource     String?
  /// Confidenza del tipo (0-1)
  audienceTypeConfidence Float?    @default(0.5)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MEMBER TRACKING (per Smart Scheduling)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Numero membri attuali del canale
  currentMemberCount     Int?
  /// Ultimo aggiornamento del conteggio membri
  memberCountUpdatedAt   DateTime?
  /// Tasso di churn settimanale (es. 0.02 = 2%)
  weeklyChurnRate        Float?
  /// Tasso di crescita settimanale
  weeklyGrowthRate       Float?
  /// Crescita netta (growth - churn)
  netGrowthRate          Float?
  /// Media crescita giornaliera ultimi 30 giorni
  avgDailyGrowth         Float?
  /// Trend crescita: 'growing' | 'stable' | 'declining'
  growthTrend            String?
  /// Revenue per subscriber (totalRevenue / memberCount)
  subscriberValue        Float?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHANNEL HEALTH
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Health score aggregato (0-100)
  healthScore            Float?
  /// Ultimo calcolo health
  healthCalculatedAt     DateTime?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  automationRules   AutomationRule[]
  dealHistory       ChannelDealHistory[]
  scheduledPosts    ScheduledPost[]
  insights          ChannelInsights?
  memberSnapshots   ChannelMemberSnapshot[]
  scheduledDeals    ScheduledDeal[]

  @@index([userId])
  @@index([platform])
  @@index([audienceType])
  @@index([healthScore])
}

// === CHANNEL DEAL HISTORY (Deduplication & Performance Tracking) ===

model ChannelDealHistory {
  id String @id @default(cuid())

  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  ruleId String?
  rule   AutomationRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRODUCT IDENTIFICATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  asin          String
  productTitle  String?
  category      String?
  subcategory   String?
  brand         String?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRICES AT PUBLICATION TIME
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dealPrice     Float?    // Current/deal price
  originalPrice Float?    // List price
  discount      Float?    // Discount percentage

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRICE HISTORY SNAPSHOT (from Keepa)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  avgPrice30       Float?   // Average price last 30 days
  minPrice30       Float?   // Minimum last 30 days
  maxPrice30       Float?   // Maximum last 30 days
  avgPrice90       Float?   // Average price last 90 days
  minPriceEver     Float?   // Historical minimum
  priceDropPercent Float?   // % drop vs 30-day average
  isLowestEver     Boolean  @default(false)  // Is historical minimum?
  isLowest30       Boolean  @default(false)  // Is 30-day minimum?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRODUCT METRICS SNAPSHOT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  salesRank         Int?     // BSR at publication time
  salesRankCategory String?  // BSR category
  rating            Float?   // Average rating (1-5)
  reviewCount       Int?     // Number of reviews

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DEAL DETAILS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Deal type: 'lightning' | 'deal_of_day' | 'coupon' | 'price_drop' | 'warehouse' | 'subscribe_save'
  dealType          String?
  dealStartTime     DateTime?  // When the deal started
  dealEndTime       DateTime?  // When the deal expires
  dealStillValid    Boolean    @default(true)   // Deal still active?
  validityCheckedAt DateTime?  // Last validity check
  dealExpiredAt     DateTime?  // When it expired

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // COUPON INFO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  hasCoupon    Boolean @default(false)
  couponValue  Float?   // Coupon value (5 = â‚¬5 or 5%)
  couponType   String?  // 'percent' | 'fixed'
  couponCode   String?  // Code if manual

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SCORING SNAPSHOT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Base score calculated (before audience adjustment)
  baseScore      Int?
  /// Final score after audience-specific weights
  finalScore     Int?
  /// Score breakdown: { discount: 25, rank: 20, rating: 15, priceDrop: 10, ... }
  scoreBreakdown Json?
  /// Audience type used for scoring
  audienceType   String?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // KEEPA RAW DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Complete Keepa data snapshot (for future analysis/ML)
  keepaSnapshot    Json?
  /// When Keepa last updated the data
  keepaLastUpdate  DateTime?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PUBLICATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publishedAt       DateTime  @default(now())
  expiresAt         DateTime  // Auto-cleanup: publishedAt + dedupeWindowHours
  telegramMessageId String?
  /// Message text sent (for copy analysis)
  messageText       String?
  /// Message format: 'template_minimal' | 'template_standard' | 'llm_generated'
  messageFormat     String?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LLM COPY TRACKING (audit & regeneration)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Text actually used for the message
  generatedCopy String?
  /// Text source: TEMPLATE | LLM | LLM_CACHE | LLM_FALLBACK_TEMPLATE
  copySource String?
  /// When text was generated (for cache invalidation)
  copyGeneratedAt DateTime?
  /// Price at generation time (to regenerate if it changes)
  priceAtGeneration Float?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ATTRIBUTION (Amazon ascsubtag)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ascsubtag used for this deal (format: ch-msg-ts-sc-rl)
  ascsubtag String?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TRACKING ID (Amazon Attribution per-deal tracking)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Amazon Attribution tracking ID used for this deal
  trackingIdUsed   String?
  // Relation to UserTrackingId (inverse of dealHistory)
  trackingIdRecord UserTrackingId?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PERFORMANCE METRICS (populated async via background job)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Total clicks on this deal
  clicks           Int   @default(0)
  /// Unique clicks
  uniqueClicks     Int   @default(0)
  /// Attributed conversions
  conversions      Int   @default(0)
  /// Total attributed revenue
  revenue          Float @default(0)
  /// Commission earned
  commissionEarned Float @default(0)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AMAZON IMPORT MATCHES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  amazonOrders AmazonOrder[] // Ordini Amazon matchati da import CSV

  @@unique([channelId, asin, publishedAt])
  @@index([channelId, publishedAt])
  @@index([asin])
  @@index([dealType])
  @@index([publishedAt])
  @@index([category])
  @@index([telegramMessageId])
  @@index([expiresAt])
  @@index([ascsubtag])
  @@index([finalScore])
  @@index([trackingIdUsed])
  @@index([dealStillValid])
}

// === PRODUCTS & AFFILIATE LINKS ===

model Brand {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id               String          @id @default(uuid())
  asin             String          @unique
  title            String
  brandId          String?
  brand            Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)
  category         String
  imageUrl         String?
  currentPrice     Float
  originalPrice    Float
  discount         Int // Calculated percentage
  salesRank        Int?
  rating           Float?
  reviewCount      Int?
  scoreComponents  Json? // Breakdown of Deal Score calculation
  lastPriceCheckAt DateTime        @default(now())
  lastKeepaRefresh DateTime        @default(now())
  keepaDataTTL     Int             @default(1440) // Minutes remaining (default 24h)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  affiliateLinks   AffiliateLink[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUSINESS FILTER SUPPORT FIELDS (populated from Keepa)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Brand name string (from Keepa, denormalized for filtering)
  brandName String?

  /// Sold directly by Amazon
  isAmazonSeller Boolean @default(false)

  /// Fulfilled by Amazon
  isFBA Boolean @default(false)

  /// Has active coupon
  hasCoupon Boolean @default(false)

  /// Coupon discount percentage (if hasCoupon is true)
  couponPercent Int?

  /// Prime eligible
  isPrime Boolean @default(false)

  /// Date product was first listed on Amazon
  listedAt DateTime?

  /// Buy Box price (may differ from currentPrice)
  buyBoxPrice Float?

  /// Number of FBA offers
  fbaOfferCount Int?

  /// Number of total new offers
  newOfferCount Int?

  /// Deal type classification
  /// - "lightning" = Lightning Deal (temporary, high confidence)
  /// - "price_drop" = Significant price drop vs historical average
  /// - "deal" = General deal (discount detected but not classified)
  /// - "warehouse" = Amazon Warehouse deal
  /// - null = Not classified or no deal
  dealType String?

  /// When the lightning deal ends (null if not a lightning deal)
  lightningEndAt DateTime?

  /// Confidence score for the deal (0-100)
  /// Higher = more likely to be a real temporary discount vs permanent price change
  dealConfidence Int?

  @@index([asin])
  @@index([category])
  @@index([salesRank])
  @@index([lastPriceCheckAt])
  @@index([brandName])
  @@index([isAmazonSeller])
  @@index([isFBA])
  @@index([hasCoupon])
  @@index([isPrime])
  @@index([listedAt])
  @@index([discount])
  @@index([rating])
  @@index([dealType])
  @@index([dealConfidence])
}

model AffiliateLink {
  id             String   @id @default(uuid())
  productId      String? // Optional: null for BOUNTY links
  product        Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amazonTag      String // e.g., "contindig-21"
  shortCode      String   @unique // Short hash for /r/:hash URLs
  shortUrl       String // Generated short link
  fullUrl        String // Full Amazon URL with tag
  destinationUrl String // Final Amazon product URL

  // Link type classification
  linkType LinkType @default(DEAL)

  // Optional: link to scheduled post (for BOUNTY/SCHEDULED types)
  scheduledPostId String?
  scheduledPost   ScheduledPost? @relation(fields: [scheduledPostId], references: [id], onDelete: SetNull)

  // Optional: channel for tracking
  channelId String?

  // Affiliate Tag for analytics tracking
  affiliateTagId  String?
  affiliateTagRef AffiliateTag? @relation("AffiliateTagRef", fields: [affiliateTagId], references: [id], onDelete: SetNull)

  // Tracking metrics
  clicks          Int   @default(0)
  totalRevenue    Float @default(0)
  conversionCount Int   @default(0)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ATTRIBUTION (Amazon ascsubtag tracking)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ascsubtag per Amazon Attribution (formato: ch-msg-ts-sc-rl)
  ascsubtag String?
  /// Deal score al momento della creazione del link
  dealScore Int?

  // Relations
  clickRecords Click[]
  conversions  Conversion[]

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([userId])
  @@index([shortCode])
  @@index([linkType])
  @@index([scheduledPostId])
  @@index([channelId])
  @@index([ascsubtag])
}

model KeepaMonthlyBudget {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month       String // e.g., "2025-11"
  tokensUsed  Int      @default(0)
  tokensLimit Int      @default(10000)
  resetAt     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, month])
  @@index([userId])
}

// === CLICK & CONVERSION TRACKING ===

model Click {
  id     String        @id @default(cuid())
  linkId String
  link   AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Tracking Data (Privacy-compliant)
  ipHash    String  // Anonymized IP hash
  userAgent String?
  referer   String?

  // Device & Browser (parsed from userAgent + client data)
  deviceType String? // "mobile", "tablet", "desktop"
  browser    String? // "Chrome", "Safari", "Firefox"...
  browserVersion String?
  os         String? // "iOS", "Android", "Windows", "macOS"...
  osVersion  String?

  // Screen & Display
  screenWidth  Int?
  screenHeight Int?
  viewportWidth  Int?
  viewportHeight Int?
  pixelRatio   Float? // Device pixel ratio (retina displays)
  touchEnabled Boolean?

  // Locale & Time
  language String? // "it-IT", "en-US"
  timezone String? // "Europe/Rome", "America/New_York"

  // Connection
  connectionType String? // "4g", "wifi", "3g", "slow-2g"
  connectionSpeed String? // "slow", "fast" (effective type)

  // GeoIP (looked up server-side)
  country     String? // "IT", "US", "DE"
  countryName String? // "Italy", "United States"
  region      String? // "Lombardia", "California"
  city        String? // "Milano", "Los Angeles"

  // UTM Tracking (from query params)
  utmSource   String? // utm_source
  utmMedium   String? // utm_medium
  utmCampaign String? // utm_campaign
  utmTerm     String? // utm_term
  utmContent  String? // utm_content

  // Visitor Tracking
  visitorId  String? // Persistent visitor ID (cookie-based)
  sessionId  String? // Session ID for this visit
  isUniqueVisitor Boolean @default(false) // First click from this visitor on this link
  isBot      Boolean @default(false) // Detected as bot/crawler

  // Telegram Source Tracking
  telegramChannelId  String?   // Channel ID or username where link was posted
  telegramMessageId  String?   // Message ID of the post containing the link
  postTimestamp      DateTime? // When the post was published (for time analysis)

  // Metadata
  clickedAt DateTime @default(now())

  @@index([linkId])
  @@index([clickedAt])
  @@index([deviceType])
  @@index([country])
  @@index([utmSource])
  @@index([visitorId])
  @@index([isBot])
  @@index([telegramChannelId])
  @@index([telegramMessageId])
}

model Conversion {
  id     String        @id @default(cuid())
  linkId String
  link   AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Conversion Data
  trackingId String @unique // External tracking ID from Amazon/affiliate network
  revenue    Float // Total sale amount
  commission Float? // Commission earned (if provided)

  // Amazon order data
  orderId  String?
  asin     String?
  quantity Int     @default(1)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ATTRIBUTION (from ascsubtag parsing)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// ascsubtag originale dalla conversione
  ascsubtag             String?
  /// Channel ID estratto da ascsubtag
  sourceChannelId       String?
  /// Message ID estratto da ascsubtag
  sourceMessageId       String?
  /// Timestamp post estratto da ascsubtag
  sourceTimestamp       DateTime?
  /// Deal score al momento della pubblicazione
  sourceDealScore       Int?
  /// Rule ID estratto da ascsubtag
  sourceRuleId          String?
  /// Metodo di attribuzione: 'ascsubtag' | 'asin_match' | 'time_window'
  attributionMethod     String?
  /// Confidenza dell'attribuzione (0-1)
  attributionConfidence Float?

  // Metadata
  convertedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([linkId])
  @@index([convertedAt])
  @@index([ascsubtag])
  @@index([sourceChannelId])
  @@index([asin])
}

// === AUTOMATION RULES ===

model AutomationRule {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BASIC INFO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  name        String
  description String?
  isActive    Boolean @default(true)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIER: FREE - Basic Filters
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Array of category IDs (Keepa format, e.g., ["166199011", "16427032011"])
  categories String[]

  /// Minimum deal score (0-100), default 35
  /// Soglie consigliate: 35 (default), 45 (qualitÃ ), 60 (top only)
  minScore Int @default(35)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIER: PRO - Advanced Filters
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Minimum price in EUR (e.g., 10.00)
  minPrice Float?

  /// Maximum price in EUR (e.g., 100.00)
  maxPrice Float?

  /// Minimum discount percentage (e.g., 20 for 20%)
  minDiscount Int?

  /// Minimum rating (0-500 scale, 400 = 4.0 stars)
  minRating Int?

  /// Minimum number of reviews
  minReviews Int?

  /// Maximum sales rank (lower = more popular)
  maxSalesRank Int?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIER: BUSINESS - Premium Filters
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Only products sold by Amazon
  amazonOnly Boolean @default(false)

  /// Only FBA (Fulfilled by Amazon) offers
  fbaOnly Boolean @default(false)

  /// Only products with active coupon
  hasCoupon Boolean @default(false)

  /// Only Prime exclusive deals
  primeOnly Boolean @default(false)

  /// Include only these brands (case-insensitive)
  brandInclude String[]

  /// Exclude these brands (case-insensitive)
  brandExclude String[]

  /// Only products listed after this date
  listedAfter DateTime?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PUBLISHING CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  channelId String?
  channel   Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)

  /// Message template ID (optional)
  templateId String?
  template   MessageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  /// A/B Split test ID (optional)
  splitId String?
  split   AutomationSplit? @relation(fields: [splitId], references: [id], onDelete: SetNull)

  /// Tipo di deal da pubblicare
  /// DISCOUNTED_ONLY = solo con prezzo barrato visibile su Amazon
  /// LOWEST_PRICE = solo al minimo storico (anche senza sconto visibile)
  /// BOTH = entrambi
  dealPublishMode DealPublishMode @default(DISCOUNTED_ONLY)

  /// Mostrare il bottone "Storico Prezzi" (link a Keepa) nel post
  showKeepaButton Boolean @default(true)

  /// Override del tag affiliato Amazon per questa automazione (sovrascrive quello del canale)
  /// DEPRECATED: Use affiliateTagId instead
  amazonTagOverride String?

  /// Affiliate Tag from Tag Pool (recommended)
  affiliateTagId String?
  affiliateTag   AffiliateTag? @relation(fields: [affiliateTagId], references: [id], onDelete: SetNull)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SCHEDULING CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// Preset: 'relaxed' | 'active' | 'intensive' | 'custom'
  schedulePreset String @default("relaxed")

  /// Intervallo in minuti tra le esecuzioni
  intervalMinutes Int @default(360) // 6 ore default

  /// Quante offerte pubblicare per esecuzione
  dealsPerRun Int @default(3)

  /// Prossima esecuzione schedulata (con jitter applicato)
  nextRunAt DateTime?

  /// Finestra deduplicazione in ore (evita ripubblicazione stesso ASIN)
  dedupeWindowHours Int @default(168) // 7 giorni

  /// Contatore run consecutive senza pubblicare (per notifica)
  emptyRunsCount Int @default(0)

  /// ModalitÃ  pubblicazione: 'smart' = usa Smart Scheduling, 'immediate' = pubblica subito
  publishingMode String @default("smart")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LLM COPY GENERATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /// ModalitÃ  generazione testo: TEMPLATE = placeholders, LLM = AI-generated
  copyMode String @default("TEMPLATE") // TEMPLATE | LLM

  /// Template per modalitÃ  TEMPLATE (con placeholders {title}, {price}, etc.)
  messageTemplate String?

  /// Istruzioni personalizzate per lo stile LLM (es. "tono informale, niente emoji")
  customStylePrompt String?

  /// Modello LLM da usare (default gpt-4o-mini per costi bassi)
  llmModel String @default("gpt-4o-mini")

  /// Limite giornaliero post con LLM per questa rule
  llmMaxPostsPerDay Int @default(50)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EXECUTION STATS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  lastRunAt DateTime?
  totalRuns Int       @default(0)

  /// Total deals published by this rule
  dealsPublished Int @default(0)

  /// Total clicks generated by this rule
  clicksGenerated Int @default(0)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  triggers AutomationTrigger[]
  actions  AutomationAction[]

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INDEXES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // History relation for deduplication
  publishHistory ChannelDealHistory[]

  // Telemetry for monitoring and tuning
  runStats AutomationRunStats[]

  // Smart scheduling queue
  scheduledDeals ScheduledDeal[]

  @@index([userId])
  @@index([isActive])
  @@index([lastRunAt])
  @@index([nextRunAt])
}

model AutomationTrigger {
  id     String         @id @default(uuid())
  ruleId String
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Trigger Type
  type TriggerType

  // Trigger Config
  config Json // {"cron": "0 */6 * * *"} or {"threshold": 85}

  createdAt DateTime @default(now())

  @@index([ruleId])
}

model AutomationAction {
  id     String         @id @default(uuid())
  ruleId String
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Action Type
  type ActionType

  // Action Config
  config Json // {"template": "default", "includeImage": true}

  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([ruleId])
}

model AutomationSplit {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Split Config
  name        String
  description String?

  // Variants
  variants Json // [{"name": "A", "weight": 50}, {"name": "B", "weight": 50}]

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  rules AutomationRule[]

  @@index([userId])
}

// === MESSAGE TEMPLATES ===

model MessageTemplate {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Template content with variables
  template String @default("ğŸ”¥ *{title}*\n\nğŸ’° Prezzo: â‚¬{price} ~â‚¬{originalPrice}~\nğŸ’¸ Risparmi: â‚¬{savings} (-{discount}%)\nâ­ Rating: {rating}/5 ({reviewCount} recensioni)\n\nğŸ‘‰ {link}")

  // AI settings
  useAI           Boolean @default(false)
  aiPrompt        String? // Custom prompt for LLM
  aiTone          String? // "professional", "casual", "enthusiastic", "urgent", "friendly"
  aiIncludeEmojis Boolean @default(true)

  // Metadata
  isDefault  Boolean   @default(false)
  usageCount Int       @default(0)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  automationRules AutomationRule[]

  @@index([userId])
  @@index([isDefault])
}

// === ONBOARDING & ANALYTICS ===

model OnboardingProgress {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Step completion flags
  welcomeSurveyCompleted Boolean  @default(false)
  channelsSelected       String[] @default([])
  telegramSetupCompleted Boolean  @default(false)
  emailSetupCompleted    Boolean  @default(false)
  discordSetupCompleted  Boolean  @default(false)
  firstAutomationCreated Boolean  @default(false)

  // Metadata
  goal            String?
  audienceSize    String?
  experienceLevel String?

  // Timing
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  lastActiveStep String?
  totalTimeSpent Int       @default(0) // seconds
  dropOffPoint   String?

  updatedAt DateTime @updatedAt
}

model AnalyticsEvent {
  id        String  @id @default(uuid())
  userId    String?
  sessionId String

  eventName     String // 'onboarding_step_viewed', 'telegram_token_validated'
  eventCategory String // 'onboarding', 'automation', 'deal_finder'
  properties    Json   @default("{}")

  userAgent String?
  ipHash    String?
  referrer  String?

  timestamp DateTime @default(now())

  @@index([eventName])
  @@index([eventCategory])
  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
}

model AutomationTemplate {
  id               String @id @default(uuid())
  name             String
  description      String
  category         String // 'popular', 'scheduled', 'premium'
  difficulty       String // 'easy', 'medium', 'advanced'
  popularity       Int    @default(0)
  estimatedRevenue String // 'â‚¬500-2000/mese'

  // Config template
  schedule   String // Cron expression
  minScore   Int
  categories String[] @default([])
  maxPrice   Int?

  // Success stories
  successStories Json @default("[]")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([category])
  @@index([popularity])
}

model Achievement {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type       String // 'fast-setup', 'first-sale', 'multi-channel', 'onboarding-complete'
  unlockedAt DateTime @default(now())

  @@index([userId])
  @@index([type])
}

model UserSession {
  id        String  @id @default(uuid())
  userId    String?
  sessionId String  @unique

  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int? // seconds

  pagesVisited String[] @default([])
  actionsCount Int      @default(0)

  device  String?
  browser String?
  os      String?

  @@index([userId])
}

// === REDIRECT & FUNNEL TRACKING ===

model ShortLink {
  id        String @id @default(cuid())
  shortCode String @unique

  // Product Info (denormalized for fast access)
  asin          String
  title         String
  imageUrl      String?
  currentPrice  Float
  originalPrice Float?
  discount      Int?

  // Amazon URL with affiliate tag
  amazonUrl String
  amazonTag String @default("afflyt-21")

  // Compliance tracking
  priceCheckedAt DateTime  @default(now())
  expiresAt      DateTime? // Optional: link expiration

  // Analytics
  clicks      Int @default(0)
  conversions Int @default(0)
  bounces     Int @default(0)

  // Source tracking
  source     String? // "telegram", "webapp", "email"
  campaignId String?
  userId     String?

  // Affiliate Tag for analytics tracking
  affiliateTagId  String?
  affiliateTagRef AffiliateTag? @relation("AffiliateTagRef", fields: [affiliateTagId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  funnelEvents RedirectFunnelEvent[]

  @@index([shortCode])
  @@index([asin])
  @@index([source])
  @@index([createdAt])
}

model RedirectFunnelEvent {
  id     String    @id @default(cuid())
  linkId String
  link   ShortLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Session tracking
  sessionId String
  visitorId String? // Cookie-based visitor ID

  // Event data
  eventType String // See FUNNEL_EVENTS enum
  eventData Json? // Additional event data

  // User consent
  hasConsent  Boolean? // For auto-redirect consent tracking
  consentType String? // "auto" | "manual"

  // Timing
  timeOnPage Int? // milliseconds
  timestamp  DateTime @default(now())

  // Device info (privacy-compliant)
  device  String? // "mobile" | "tablet" | "desktop"
  browser String?
  os      String?

  @@index([linkId])
  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
}

// === NOTIFICATION MODEL ===

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     NotificationType
  channel  NotificationChannel
  status   NotificationStatus   @default(PENDING)
  category NotificationCategory @default(SYSTEM)
  priority NotificationPriority @default(MEDIUM)

  // Content
  title String
  body  String
  icon  String? // Lucide icon name (e.g., "Bell", "AlertTriangle")
  data  Json? // Additional data for the notification

  // Action
  actionUrl   String? // URL to navigate on click
  actionLabel String? // Button/link text

  // Delivery tracking
  sentAt      DateTime?
  readAt      DateTime?
  dismissedAt DateTime?
  failedAt    DateTime?
  error       String?

  // Retry logic
  attempts   Int @default(0)
  maxRetries Int @default(3)

  // Auto-dismiss (milliseconds, null = manual)
  autoDismissMs Int?

  createdAt DateTime @default(now())
  expiresAt DateTime? // Optional expiration

  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([type])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([createdAt])
}

// === BILLING MODELS (Stripe-ready) ===

model Subscription {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe IDs
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Status
  status SubscriptionStatus @default(ACTIVE)
  plan   PlanType           @default(FREE)

  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoices       Invoice[]
  paymentMethods PaymentMethod[]

  @@index([stripeCustomerId])
  @@index([status])
}

model Invoice {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Stripe IDs
  stripeInvoiceId String? @unique

  // Invoice data
  amount   Float
  currency String @default("EUR")
  status   String // "paid", "open", "void", "uncollectible"

  // URLs
  invoicePdf       String?
  hostedInvoiceUrl String?

  // Dates
  periodStart DateTime?
  periodEnd   DateTime?
  paidAt      DateTime?

  createdAt DateTime @default(now())

  @@index([subscriptionId])
  @@index([status])
}

model PaymentMethod {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Stripe ID
  stripePaymentMethodId String? @unique

  // Card info (safe to store)
  type     String // "card", "sepa_debit", etc.
  last4    String?
  brand    String? // "visa", "mastercard", etc.
  expMonth Int?
  expYear  Int?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([subscriptionId])
}

// === KEEPA TOKEN TRACKING ===

model KeepaTokenLog {
  id           String   @id @default(cuid())
  operation    String // 'deal_search' | 'product_refresh'
  tokenCost    Int
  category     String?
  asins        String[] // Lista ASIN se product call
  jobId        String?
  success      Boolean
  responseTime Int // ms
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([category])
  @@index([operation])
}

// === NEW AUTOMATION MODEL (Redis Queue Compatible) ===

model Automation {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  enabled     Boolean @default(true)

  // Scheduling
  intervalMinutes Int       @default(360) // Every 6 hours by default
  nextRunAt       DateTime
  lastRunAt       DateTime?

  // Filters (JSON for flexibility)
  filters Json // { categories, minDiscount, maxPrice, minRating, etc. }

  // Publishing
  telegramChatId String?
  templateId     String?

  // Stats
  totalRuns      Int @default(0)
  dealsPublished Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([enabled])
  @@index([nextRunAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOB TELEMETRY - Per monitorare performance e tarare soglie
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model AutomationRunStats {
  id     String         @id @default(cuid())
  ruleId String
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Pipeline counts
  dealsFetched      Int // Deals dalla Deal API
  dealsAfterFilters Int // Dopo filtri base (price, brand, etc)
  dealsAfterMode    Int // Dopo filtro dealPublishMode
  dealsPassingScore Int // Passano minScore
  dealsPublished    Int // Effettivamente pubblicati

  // Score statistics
  avgScore Float? // Media score dei deals dopo filtri base
  minScore Float? // Score minimo
  maxScore Float? // Score massimo
  stdDev   Float? // Deviazione standard

  // Thresholds used
  minScoreThreshold Int // minScore usato per filtrare
  dealPublishMode   String // DISCOUNTED_ONLY, LOWEST_PRICE, BOTH

  // Performance
  durationMs Int // Tempo esecuzione in ms
  cacheHit   Boolean @default(false) // Se ha usato cache

  createdAt DateTime @default(now())

  @@index([ruleId])
  @@index([createdAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULER - Scheduled Posts for non-deal content
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ScheduledPost {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Type and content
  type     ScheduledPostType
  name     String // Identificative name
  content  String // Message content (can include {{variables}})
  mediaUrl String? // Optional image/video URL

  // Scheduling
  schedule String // Cron expression (e.g., "0 9 * * *")
  timezone String  @default("Europe/Rome") // IANA timezone
  isActive Boolean @default(true)

  // Conflict detection settings (JSON)
  conflictSettings Json? // { skipIfDealPending, bufferMinutes, rescheduleOnConflict }

  // Type-specific settings (JSON)
  settings Json? // BountySettings, RecapSettings, CrossPromoSettings, etc.

  // Affiliate Tag for bounty/link tracking
  affiliateTagId String?
  affiliateTag   AffiliateTag? @relation(fields: [affiliateTagId], references: [id], onDelete: SetNull)

  // Execution tracking
  lastRunAt DateTime?
  nextRunAt DateTime?
  runCount  Int       @default(0)
  failCount Int       @default(0) // Consecutive failures

  // Performance aggregate
  totalClicks Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executions     ScheduledPostExecution[]
  affiliateLinks AffiliateLink[]

  @@index([userId])
  @@index([channelId])
  @@index([nextRunAt])
  @@index([isActive, nextRunAt])
  @@index([type])
}

model ScheduledPostExecution {
  id              String        @id @default(cuid())
  scheduledPostId String
  scheduledPost   ScheduledPost @relation(fields: [scheduledPostId], references: [id], onDelete: Cascade)

  // Execution details
  executedAt DateTime        @default(now())
  status     ExecutionStatus

  // Telegram response
  messageId String? // Telegram message ID
  chatId    String? // Telegram chat ID

  // Error tracking
  error      String? // Error message if failed
  errorCode  String? // Error code for categorization
  retryCount Int     @default(0)

  // Performance metrics (populated async)
  clicks Int @default(0)

  // Content snapshot (for debugging)
  contentSnapshot String? // Content that was sent

  // Conflict info (if skipped)
  conflictReason String? // RECENT_DEAL, PENDING_DEAL, etc.
  rescheduledTo  DateTime? // If rescheduled, when

  @@index([scheduledPostId])
  @@index([executedAt])
  @@index([status])
}

model BountyTemplate {
  id String @id @default(cuid())

  // Template info
  name       String // e.g., "Amazon Prime IT"
  bountyType String // PRIME, AUDIBLE, MUSIC, KINDLE
  locale     String @default("it") // Template language

  // URLs
  baseUrl  String // URL without tag
  tagParam String @default("tag") // Tag parameter name

  // Default content per style
  casualCopy       String? // Casual style copy
  professionalCopy String? // Professional style copy
  urgentCopy       String? // Urgent style copy

  // Emoji
  emoji String? // Suggested emoji

  // Metadata
  avgCommission Float? // Estimated average commission
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bountyType])
  @@index([locale])
}

// === AFFILIATE TAG POOL ===
// Gestione centralizzata dei tag Amazon per analytics granulari

model AffiliateTag {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tag         String // Amazon tag (e.g., "afflyt-21")
  label       String // User-friendly label (e.g., "Tag Principale", "Tag Tech")
  marketplace String @default("IT") // IT, DE, FR, ES, UK, US

  isDefault Boolean @default(false) // Default tag for new automations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations for analytics tracking
  automationRules AutomationRule[]
  scheduledPosts  ScheduledPost[]
  affiliateLinks  AffiliateLink[]  @relation("AffiliateTagRef")
  shortLinks      ShortLink[]      @relation("AffiliateTagRef")

  @@unique([userId, tag])
  @@index([userId])
  @@index([isDefault])
}

// === BETA INVITE CODES ===
// One code per tester, format: AFFLYT-XXXX-XXXX

model BetaInviteCode {
  id String @id @default(uuid())

  // Code (unique, format: AFFLYT-XXXX-XXXX)
  code String @unique

  // Optional: Pre-assign to specific email
  assignedEmail String?

  // Status
  isActive   Boolean   @default(true)
  usedAt     DateTime? // When the code was redeemed
  expiresAt  DateTime? // Optional expiration date

  // Metadata
  createdBy  String?   // Admin who created the code
  notes      String?   // Internal notes

  // Relations
  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([assignedEmail])
  @@index([isActive])
}

// === ACTIVE SESSIONS ===
// Track user login sessions for security

model Session {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session token (hashed JWT ID or session ID)
  tokenHash String @unique

  // Device info
  userAgent   String?
  ipAddress   String?
  deviceType  String? // "desktop", "mobile", "tablet"
  browser     String?
  os          String?
  location    String? // Approximate location from IP

  // Activity tracking
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime

  // Security
  isRevoked Boolean @default(false)
  revokedAt DateTime?
  revokedReason String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([isRevoked])
}

// === TELEGRAM USER TRACKING ===
// Tracks Telegram users who interact with affiliate bots for attribution

model TelegramUser {
  id String @id @default(cuid())

  // Telegram user data
  telegramUserId   String  // Telegram user ID (BigInt as string)
  username         String? // @username (may be null)
  firstName        String?
  lastName         String?
  languageCode     String? // e.g., "it", "en"
  isPremium        Boolean @default(false)

  // Chat for direct messaging (private chat with bot)
  privateChatId    String? // Chat ID for 1:1 communication

  // Bot relation (which bot they interacted with)
  credentialId     String?
  credential       Credential? @relation(fields: [credentialId], references: [id], onDelete: SetNull)

  // Optional: Link to Afflyt user if they authenticated
  linkedUserId     String?
  linkedUser       User?    @relation(fields: [linkedUserId], references: [id], onDelete: SetNull)

  // Engagement tracking
  firstSeenAt      DateTime @default(now())
  lastActiveAt     DateTime @default(now())
  messageCount     Int      @default(0) // Messages sent to bot
  clickCount       Int      @default(0) // Affiliate link clicks

  // Source tracking (how they found the bot)
  sourceChannelId  String? // Channel where they first saw a deal
  sourceMessageId  String? // Message that brought them

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interactions TelegramInteraction[]

  @@unique([telegramUserId, credentialId])
  @@index([telegramUserId])
  @@index([username])
  @@index([linkedUserId])
  @@index([credentialId])
  @@index([lastActiveAt])
}

// Track individual interactions from Telegram users
model TelegramInteraction {
  id String @id @default(cuid())

  telegramUserId String
  telegramUser   TelegramUser @relation(fields: [telegramUserId], references: [id], onDelete: Cascade)

  // Interaction type
  type           String // 'click' | 'message' | 'command' | 'callback'

  // Context
  channelId      String? // Channel where interaction originated
  messageId      String? // Message ID if applicable
  asin           String? // Product ASIN if click
  linkId         String? // AffiliateLink ID if click

  // Metadata
  data           Json?   // Additional interaction data

  createdAt DateTime @default(now())

  @@index([telegramUserId])
  @@index([type])
  @@index([channelId])
  @@index([asin])
  @@index([createdAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANNEL INSIGHTS - Analytics aggregati per canale (per Smart Scheduling)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ChannelInsights {
  id String @id @default(cuid())

  // Reference (1:1 con Channel)
  channelId String  @unique
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HOURLY STATS (per Smart Scheduling)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Stats per ora: { "0": { posts, clicks, conversions, ctr, cvr }, ... "23": {...} }
  hourlyStats Json?
  /// Top 5 ore migliori per performance
  bestHours   Int[] @default([])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DAILY STATS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Stats per giorno: { "monday": {...}, ... "sunday": {...} }
  dailyStats Json?
  /// Giorni migliori ordinati per performance
  bestDays   String[] @default([])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CATEGORY STATS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Stats per categoria: { "electronics": { posts, clicks, conversions, cvr }, ... }
  categoryStats Json?
  /// Top categorie per conversione
  topCategories String[] @default([])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRICE STATS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Stats per fascia prezzo: { "0-25": {...}, "25-50": {...}, ... }
  priceStats        Json?
  /// Range prezzo ottimale per questo canale
  optimalPriceRange Json?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DISCOUNT STATS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Stats per fascia sconto: { "15-25": {...}, "25-40": {...}, ... }
  discountStats        Json?
  /// Range sconto ottimale per questo canale
  optimalDiscountRange Json?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DEAL TYPE STATS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Stats per tipo deal: { "lightning": { posts, cvr, avgRevenue }, "coupon": {...} }
  dealTypeStats Json?
  /// Migliori tipi di deal per questo canale
  bestDealTypes String[] @default([])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DYNAMIC WEIGHTS (per audience type - Deal Score personalizzato)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Correlazioni calcolate: { discount: 0.45, salesRank: 0.72, rating: 0.38, priceDrop: 0.21 }
  factorCorrelations Json?
  /// Pesi per scoring: { discount: 0.15, salesRank: 0.45, rating: 0.28, priceDrop: 0.12 }
  scoreWeights       Json?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AUDIENCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Tipo audience ereditato o inferito
  audienceType           String?
  /// Confidenza del tipo (0-1)
  audienceTypeConfidence Float?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AGGREGATES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  totalPosts       Int   @default(0)
  totalClicks      Int   @default(0)
  totalConversions Int   @default(0)
  totalRevenue     Float @default(0)
  avgCtr           Float?  // Click-through rate medio
  avgCvr           Float?  // Conversion rate medio
  avgEpc           Float?  // Earnings per click
  avgOrderValue    Float?  // Average order value

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MEMBER METRICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Media membri nel periodo
  avgMemberCount      Int?
  /// Crescita membri negli ultimi 30 giorni
  memberGrowth30d     Int?
  /// % crescita membri
  memberGrowthPercent Float?
  /// % churn dopo post (correlazione post â†’ unsubscribe)
  churnAfterPosts     Float?
  /// Revenue per subscriber
  subscriberValue     Float?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // META
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  /// Confidenza complessiva (0-1) basata su volume dati
  confidence     Float     @default(0)
  /// Numero di deal analizzati
  dataPoints     Int       @default(0)
  /// Periodo di analisi in giorni
  periodDays     Int       @default(30)
  /// Ultimo ricalcolo insights
  lastCalculated DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastCalculated])
  @@index([confidence])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANNEL MEMBER SNAPSHOTS - Storico membri per tracking crescita/churn
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ChannelMemberSnapshot {
  id String @id @default(cuid())

  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  /// Numero membri al momento dello snapshot
  memberCount  Int
  /// Variazione rispetto allo snapshot precedente
  delta        Int?
  /// Variazione percentuale
  deltaPercent Float?

  /// Sorgente dati: 'telegram_api' | 'manual' | 'estimated'
  source String @default("telegram_api")

  snapshotAt DateTime @default(now())

  @@index([channelId, snapshotAt])
  @@index([snapshotAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCT PRICE HISTORY - Tracking price trends over time
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ProductPriceHistory {
  id String @id @default(cuid())

  asin String

  // Snapshot data
  recordedAt DateTime @default(now())

  // Prices
  currentPrice Float
  listPrice    Float?

  // Deal info
  isDeal    Boolean @default(false)
  dealType  String?
  dealPrice Float?

  // Metrics
  salesRank   Int?
  rating      Float?
  reviewCount Int?

  // Source
  source String @default("keepa") // 'keepa' | 'manual' | 'api'

  createdAt DateTime @default(now())

  @@index([asin, recordedAt])
  @@index([asin])
  @@index([recordedAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULED DEALS - Coda Smart Scheduling per pubblicazione ottimale
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ScheduledDeal {
  id String @id @default(cuid())

  // References
  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  ruleId    String
  rule      AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Product info
  asin         String
  productId    String?
  productTitle String?

  // Scoring
  baseScore  Int
  finalScore Int

  // Deal info snapshot
  /// Tipo deal: 'lightning' | 'deal' | 'price_drop' | 'coupon' | 'deal_of_day'
  dealType      String?
  originalPrice Float?
  dealPrice     Float?
  discount      Float?
  category      String?
  /// When the deal ends (for lightning deals)
  dealEndTime   DateTime?

  // Scheduling
  scheduledFor DateTime
  /// Motivo scheduling: 'best_hour' | 'next_slot' | 'lightning_priority' | 'immediate' | 'fallback'
  reason       String?

  // Status
  /// Stato: 'pending' | 'published' | 'cancelled' | 'failed' | 'expired'
  status String @default("pending")

  // Results
  publishedAt       DateTime?
  cancelledAt       DateTime?
  cancelReason      String?
  telegramMessageId String?

  // Error tracking
  lastError    String?
  failedAt     DateTime?
  retryCount   Int      @default(0)
  maxRetries   Int      @default(3)

  // Tracking
  trackingIdUsed String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId, status])
  @@index([scheduledFor])
  @@index([status, scheduledFor])
  @@index([ruleId])
  @@index([asin])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER TRACKING ID POOL - Amazon Attribution tracking IDs per user
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model UserTrackingId {
  id              String    @id @default(cuid())

  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Amazon Attribution tracking ID (e.g., "maui_store-20_tracking_id_12345")
  trackingId      String

  /// Status: 'available' | 'in_use'
  status          String    @default("available")

  /// When this tracking ID was assigned to a deal
  assignedAt      DateTime?

  /// When this tracking ID assignment expires (24h after assignment)
  expiresAt       DateTime?

  /// Link to the deal using this tracking ID (1:1)
  dealHistoryId   String?   @unique
  dealHistory     ChannelDealHistory? @relation(fields: [dealHistoryId], references: [id], onDelete: SetNull)

  /// Total times this tracking ID has been used
  totalUses       Int       @default(0)

  /// Last time this tracking ID was used
  lastUsedAt      DateTime?

  createdAt       DateTime  @default(now())

  @@unique([userId, trackingId])
  @@index([userId, status])
  @@index([expiresAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AMAZON ASSOCIATES CSV IMPORT - Import storico ordini e guadagni
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model AmazonReportImport {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // File info
  fileName   String
  reportType String // 'orders' | 'earnings' | 'daily_trends' | 'tracking' | 'link_type'
  fileSize   Int // bytes

  // Period covered
  periodStart DateTime?
  periodEnd   DateTime?

  // Results
  status       String @default("pending") // 'pending' | 'processing' | 'completed' | 'failed'
  rowsTotal    Int    @default(0)
  rowsImported Int    @default(0)
  rowsSkipped  Int    @default(0)
  rowsFailed   Int    @default(0)

  // Match stats
  matchedDeals   Int @default(0) // Righe matchate con ChannelDealHistory
  unmatchedDeals Int @default(0) // Righe non matchate (pre-Afflyt o altri canali)

  // Error tracking
  errors Json? // Array di errori per riga

  // Timestamps
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  orders AmazonOrder[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model AmazonOrder {
  id String @id @default(cuid())

  userId   String
  user     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  importId String?
  import   AmazonReportImport?  @relation(fields: [importId], references: [id], onDelete: SetNull)

  // Order data
  asin         String
  productTitle String?
  category     String?
  orderDate    DateTime
  quantity     Int      @default(1)
  price        Float

  // Link info
  linkType   String? // 'ml1', 'ml2', 'Others', 'Text Only Image Only...'
  trackingId String? // 'topoffertetec-21'
  orderType  String? // 'di' (direct), 'ndi' (non-direct)
  deviceType String? // 'PHONE', 'DESKTOP', 'TABLET'

  // Shipping/Earnings (from Fee-Earnings)
  shippedDate      DateTime?
  shippedQuantity  Int?
  returns          Int       @default(0)
  revenue          Float?
  commission       Float?
  seller           String? // 'Amazon.it', '3rd Party'
  isDirectPurchase Boolean? // 'Acquisto idoneo diretto' Y/N

  // Match with Afflyt
  matchedDealId   String? // ID di ChannelDealHistory se matchato
  matchedDeal     ChannelDealHistory? @relation(fields: [matchedDealId], references: [id], onDelete: SetNull)
  matchConfidence Float? // 0-1, quanto siamo sicuri del match

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, asin, orderDate, trackingId])
  @@index([userId])
  @@index([asin])
  @@index([trackingId])
  @@index([orderDate])
  @@index([matchedDealId])
}

model AmazonDailyStats {
  id String @id @default(cuid())

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  importId String?

  // Daily data
  date           DateTime @db.Date
  clicks         Int      @default(0)
  ordersAmazon   Int      @default(0) // Articoli ordinati (Amazon)
  orders3rdParty Int      @default(0) // Articoli ordinati (3rd Party)
  ordersTotal    Int      @default(0)
  conversionRate Float? // % dal report

  createdAt DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model AmazonTrackingStats {
  id String @id @default(cuid())

  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  importId String?

  // Tracking summary
  trackingId  String
  periodStart DateTime?
  periodEnd   DateTime?

  clicks       Int   @default(0)
  orderedItems Int   @default(0)
  shippedItems Int   @default(0)
  revenue      Float @default(0)
  commission   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, trackingId, periodStart, periodEnd])
  @@index([userId])
  @@index([trackingId])
}
