generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === ENUMS (PostgreSQL native) ===

enum PlanType {
  FREE
  PRO
  BUSINESS
}

enum UserRole {
  USER
  ADMIN
}

enum AuthTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  MAGIC_LINK
}

enum ChannelPlatform {
  TELEGRAM
  DISCORD
}

enum ChannelStatus {
  CONNECTED
  PENDING
  ERROR
}

enum TriggerType {
  SCHEDULE
  SCORE_THRESHOLD
  PRICE_DROP
}

enum ActionType {
  PUBLISH_CHANNEL
  SEND_EMAIL
  WEBHOOK
}

// === USER & AUTHENTICATION ===

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  name                String?
  password            String?              // Hashed password (bcrypt)
  role                UserRole             @default(USER)
  plan                PlanType             @default(FREE)
  ttl                 Int                  @default(72) // hours
  brandId             String?

  // Email verification
  emailVerified       Boolean              @default(false)
  emailVerifiedAt     DateTime?

  // Account status
  isActive            Boolean              @default(true)
  lastLoginAt         DateTime?
  failedLoginAttempts Int                  @default(0)
  lockedUntil         DateTime?

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  // Relations
  apiKeys             ApiKey[]
  credentials         Credential[]
  channels            Channel[]
  affiliateLinks      AffiliateLink[]
  keepaBudgets        KeepaMonthlyBudget[]
  automationRules     AutomationRule[]
  automationSplits    AutomationSplit[]
  messageTemplates    MessageTemplate[]
  onboardingProgress  OnboardingProgress?
  achievements        Achievement[]
  authTokens          AuthToken[]

  @@index([email])
  @@index([plan])
}

model AuthToken {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String        @unique // Secure random token (hashed)
  type      AuthTokenType

  expiresAt DateTime
  usedAt    DateTime?     // When the token was used (null if not used)

  // Metadata for security
  ipAddress String?
  userAgent String?

  createdAt DateTime      @default(now())

  @@index([userId])
  @@index([token])
  @@index([type])
  @@index([expiresAt])
}

model ApiKey {
  id        String    @id @default(uuid())
  key       String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([userId])
}

// === CREDENTIALS & CHANNELS ===

model Credential {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider  String    // e.g., "OPENAI", "ANTHROPIC", "TELEGRAM_BOT"
  key       String    // Encrypted value
  label     String?   // User friendly name
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  channels  Channel[]

  @@index([userId])
  @@index([provider])
}

model Channel {
  id              String           @id @default(uuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  platform        ChannelPlatform
  channelId       String           // e.g., "@mychannel" or "-100..."
  credentialId    String?
  credential      Credential?      @relation(fields: [credentialId], references: [id], onDelete: SetNull)
  status          ChannelStatus    @default(PENDING)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  automationRules AutomationRule[]

  @@index([userId])
  @@index([platform])
}

// === PRODUCTS & AFFILIATE LINKS ===

model Brand {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id               String          @id @default(uuid())
  asin             String          @unique
  title            String
  brandId          String?
  brand            Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)
  category         String
  imageUrl         String?
  currentPrice     Float
  originalPrice    Float
  discount         Int             // Calculated percentage
  salesRank        Int?
  rating           Float?
  reviewCount      Int?
  scoreComponents  Json?           // Breakdown of Deal Score calculation
  lastPriceCheckAt DateTime        @default(now())
  lastKeepaRefresh DateTime        @default(now())
  keepaDataTTL     Int             @default(1440) // Minutes remaining (default 24h)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  affiliateLinks   AffiliateLink[]

  @@index([asin])
  @@index([category])
  @@index([salesRank])
  @@index([lastPriceCheckAt])
}

model AffiliateLink {
  id             String  @id @default(uuid())
  productId      String
  product        Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId         String
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  amazonTag      String  // e.g., "contindig-21"
  shortCode      String  @unique // Short hash for /r/:hash URLs
  shortUrl       String  // Generated short link
  fullUrl        String  // Full Amazon URL with tag
  destinationUrl String  // Final Amazon product URL

  // Tracking metrics
  clicks          Int   @default(0)
  totalRevenue    Float @default(0)
  conversionCount Int   @default(0)

  // Relations
  clickRecords Click[]
  conversions  Conversion[]

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([userId])
  @@index([shortCode])
}

model KeepaMonthlyBudget {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month       String   // e.g., "2025-11"
  tokensUsed  Int      @default(0)
  tokensLimit Int      @default(10000)
  resetAt     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, month])
  @@index([userId])
}

// === CLICK & CONVERSION TRACKING ===

model Click {
  id     String        @id @default(cuid())
  linkId String
  link   AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Tracking Data (Privacy-compliant)
  ipHash    String  // Anonymized IP hash
  userAgent String?
  referer   String?

  // Metadata
  clickedAt DateTime @default(now())

  @@index([linkId])
  @@index([clickedAt])
}

model Conversion {
  id     String        @id @default(cuid())
  linkId String
  link   AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Conversion Data
  trackingId String  @unique // External tracking ID from Amazon/affiliate network
  revenue    Float   // Total sale amount
  commission Float?  // Commission earned (if provided)

  // Metadata
  convertedAt DateTime @default(now())

  @@index([linkId])
  @@index([convertedAt])
}

// === AUTOMATION RULES ===

model AutomationRule {
  id     String   @id @default(uuid())
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Rule Config
  name        String
  description String?
  isActive    Boolean @default(true)

  // Targeting
  categories String[] // Array of categories
  minScore   Int      @default(70)
  maxPrice   Float?

  // Publishing Config
  channelId String?
  channel   Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)

  // Message Template
  templateId String?
  template   MessageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // A/B Testing
  splitId String?
  split   AutomationSplit? @relation(fields: [splitId], references: [id], onDelete: SetNull)

  // Metadata
  lastRunAt DateTime?
  totalRuns Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  triggers AutomationTrigger[]
  actions  AutomationAction[]

  @@index([userId])
  @@index([isActive])
}

model AutomationTrigger {
  id     String         @id @default(uuid())
  ruleId String
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Trigger Type
  type TriggerType

  // Trigger Config
  config Json // {"cron": "0 */6 * * *"} or {"threshold": 85}

  createdAt DateTime @default(now())

  @@index([ruleId])
}

model AutomationAction {
  id     String         @id @default(uuid())
  ruleId String
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Action Type
  type ActionType

  // Action Config
  config Json // {"template": "default", "includeImage": true}

  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([ruleId])
}

model AutomationSplit {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Split Config
  name        String
  description String?

  // Variants
  variants Json // [{"name": "A", "weight": 50}, {"name": "B", "weight": 50}]

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  rules AutomationRule[]

  @@index([userId])
}

// === MESSAGE TEMPLATES ===

model MessageTemplate {
  id          String @id @default(uuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Template content with variables
  template String @default("üî• *{title}*\n\nüí∞ Prezzo: ‚Ç¨{price} ~‚Ç¨{originalPrice}~\nüí∏ Risparmi: ‚Ç¨{savings} (-{discount}%)\n‚≠ê Rating: {rating}/5 ({reviewCount} recensioni)\n\nüëâ {link}")

  // AI settings
  useAI           Boolean @default(false)
  aiPrompt        String? // Custom prompt for LLM
  aiTone          String? // "professional", "casual", "enthusiastic", "urgent", "friendly"
  aiIncludeEmojis Boolean @default(true)

  // Metadata
  isDefault  Boolean   @default(false)
  usageCount Int       @default(0)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  automationRules AutomationRule[]

  @@index([userId])
  @@index([isDefault])
}

// === ONBOARDING & ANALYTICS ===

model OnboardingProgress {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Step completion flags
  welcomeSurveyCompleted Boolean  @default(false)
  channelsSelected       String[] @default([])
  telegramSetupCompleted Boolean  @default(false)
  emailSetupCompleted    Boolean  @default(false)
  discordSetupCompleted  Boolean  @default(false)
  firstAutomationCreated Boolean  @default(false)

  // Metadata
  goal            String?
  audienceSize    String?
  experienceLevel String?

  // Timing
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  lastActiveStep String?
  totalTimeSpent Int       @default(0) // seconds
  dropOffPoint   String?

  updatedAt DateTime @updatedAt
}

model AnalyticsEvent {
  id        String  @id @default(uuid())
  userId    String?
  sessionId String

  eventName     String // 'onboarding_step_viewed', 'telegram_token_validated'
  eventCategory String // 'onboarding', 'automation', 'deal_finder'
  properties    Json   @default("{}")

  userAgent String?
  ipHash    String?
  referrer  String?

  timestamp DateTime @default(now())

  @@index([eventName])
  @@index([eventCategory])
  @@index([userId])
  @@index([sessionId])
  @@index([timestamp])
}

model AutomationTemplate {
  id               String   @id @default(uuid())
  name             String
  description      String
  category         String   // 'popular', 'scheduled', 'premium'
  difficulty       String   // 'easy', 'medium', 'advanced'
  popularity       Int      @default(0)
  estimatedRevenue String   // '‚Ç¨500-2000/mese'

  // Config template
  schedule   String   // Cron expression
  minScore   Int
  categories String[] @default([])
  maxPrice   Int?

  // Success stories
  successStories Json @default("[]")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([category])
  @@index([popularity])
}

model Achievement {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type       String   // 'fast-setup', 'first-sale', 'multi-channel', 'onboarding-complete'
  unlockedAt DateTime @default(now())

  @@index([userId])
  @@index([type])
}

model UserSession {
  id        String  @id @default(uuid())
  userId    String?
  sessionId String  @unique

  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int?      // seconds

  pagesVisited String[] @default([])
  actionsCount Int      @default(0)

  device  String?
  browser String?
  os      String?

  @@index([userId])
}

// === REDIRECT & FUNNEL TRACKING ===

model ShortLink {
  id        String  @id @default(cuid())
  shortCode String  @unique

  // Product Info (denormalized for fast access)
  asin          String
  title         String
  imageUrl      String?
  currentPrice  Float
  originalPrice Float?
  discount      Int?

  // Amazon URL with affiliate tag
  amazonUrl String
  amazonTag String @default("afflyt-21")

  // Compliance tracking
  priceCheckedAt DateTime  @default(now())
  expiresAt      DateTime? // Optional: link expiration

  // Analytics
  clicks      Int @default(0)
  conversions Int @default(0)
  bounces     Int @default(0)

  // Source tracking
  source     String? // "telegram", "webapp", "email"
  campaignId String?
  userId     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  funnelEvents RedirectFunnelEvent[]

  @@index([shortCode])
  @@index([asin])
  @@index([source])
  @@index([createdAt])
}

model RedirectFunnelEvent {
  id     String    @id @default(cuid())
  linkId String
  link   ShortLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Session tracking
  sessionId String
  visitorId String? // Cookie-based visitor ID

  // Event data
  eventType String // See FUNNEL_EVENTS enum
  eventData Json?  // Additional event data

  // User consent
  hasConsent  Boolean? // For auto-redirect consent tracking
  consentType String?  // "auto" | "manual"

  // Timing
  timeOnPage Int?     // milliseconds
  timestamp  DateTime @default(now())

  // Device info (privacy-compliant)
  device  String? // "mobile" | "tablet" | "desktop"
  browser String?
  os      String?

  @@index([linkId])
  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
}
